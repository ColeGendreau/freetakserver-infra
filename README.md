# OpenTAKServer Infrastructure

One-click deploy/destroy for [OpenTAKServer (OTS)](https://opentakserver.io/) on DigitalOcean using Terraform and GitHub Actions. Fork this repo, add two secrets, click **deploy**, and you have a fully functional TAK server with automatic certificate management in ~15 minutes.

## What Gets Deployed

A single DigitalOcean droplet running Ubuntu 22.04 with:

- **OpenTAKServer** — TCP and SSL Cursor-on-Target (CoT) streaming
- **Web UI** — browser-based admin dashboard with user authentication
- **Automatic CA** — certificate authority generated on first boot; no manual cert wrangling
- **Certificate Enrollment** — clients (ATAK/iTAK) auto-enroll for client certs via the server
- **MediaMTX** — RTSP video streaming and recording
- **RabbitMQ** — message broker for CoT routing
- **Nginx** — TLS termination and reverse proxy
- **DigitalOcean Firewall** — only required ports are exposed

## Prerequisites

- A **GitHub** account (free)
- A **DigitalOcean** account ([sign up](https://cloud.digitalocean.com/registrations/new)) with a payment method on file
- An **SSH key pair** on your local machine (used to SSH into the server for troubleshooting)

If you don't have an SSH key yet:

```bash
ssh-keygen -t ed25519 -C "your_email@example.com"
```

This creates `~/.ssh/id_ed25519` (private) and `~/.ssh/id_ed25519.pub` (public).

## Quick Start (Fork & Deploy)

### Step 1 — Fork this repository

Click the **Fork** button at the top-right of this repo. This creates your own copy under your GitHub account.

### Step 2 — Create a DigitalOcean API token

1. Log in to [DigitalOcean](https://cloud.digitalocean.com/)
2. Go to **API** in the left sidebar (or visit [cloud.digitalocean.com/account/api/tokens](https://cloud.digitalocean.com/account/api/tokens))
3. Click **Generate New Token**
4. Give it a name (e.g. `opentakserver`), select **Read + Write** scope, and click **Generate Token**
5. Copy the token immediately — you won't be able to see it again

### Step 3 — Add secrets to your fork

In your forked repo on GitHub:

1. Go to **Settings** > **Secrets and variables** > **Actions**
2. Click **New repository secret** and add each of these:

| Secret Name | Value | How to get it |
|-------------|-------|---------------|
| `DO_TOKEN` | Your DigitalOcean API token | Step 2 above |
| `SSH_PUBLIC_KEY` | Contents of your public key | Run `cat ~/.ssh/id_ed25519.pub` and paste the output |

The `SSH_PUBLIC_KEY` value should look like:

```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAA... your_email@example.com
```

### Step 4 — Deploy

1. In your fork, go to the **Actions** tab
2. You may see a banner saying "Workflows aren't being run on this fork" — click **I understand my workflows, go ahead and enable them**
3. In the left sidebar, click **OpenTAKServer**
4. Click **Run workflow** > select **deploy** > click the green **Run workflow** button

The workflow will:
- Provision a DigitalOcean droplet (~1 minute)
- Install OpenTAKServer via cloud-init (~10-15 minutes in the background)

### Step 5 — Find your server IP

After the workflow completes (green check), click into the run and expand the **Show Outputs** step. You'll see:

```
droplet_ip = "YOUR_SERVER_IP"
web_ui_url = "https://YOUR_SERVER_IP"
ssl_cot_url = "YOUR_SERVER_IP:8089"
cert_enrollment_url = "https://YOUR_SERVER_IP:8446"
truststore_url = "https://YOUR_SERVER_IP/api/truststore"
```

### Step 6 — Wait for installation to finish

The droplet is provisioned quickly, but OTS installs in the background via cloud-init. Monitor progress by SSHing in:

```bash
ssh root@YOUR_SERVER_IP 'tail -f /var/log/ots-install.log'
```

When you see the banner below, the server is ready:

```
=========================================
  OpenTAKServer Installation Complete!
=========================================
```

### Step 7 — Log in to the Web UI

1. Open `https://YOUR_SERVER_IP` in your browser
2. You'll get a certificate warning (self-signed cert) — click **Advanced** > **Proceed** to accept it
3. Log in with the default credentials:
   - **Username:** `administrator`
   - **Password:** `password`
4. **Change the password immediately** after logging in (top-right menu > Profile)

## Connecting TAK Clients

OpenTAKServer handles certificates automatically. Clients enroll by authenticating with their username/password, and the server issues them a client certificate. The easiest way to connect is with **data packages** generated by the Web UI.

### Step 1 — Create user accounts

1. Log in to `https://YOUR_SERVER_IP` as `administrator`
2. Go to **Users** and create a new user for each device (e.g. `Alice`, `Bob`)
3. Set a password for each user

### Step 2 — Add users to groups

For devices to see each other on the map and chat:

1. In the Web UI, go to **Groups**
2. Click **Manage Users** on the **\_\_ANON\_\_** group
3. Add each user to the group and make sure both the **IN** and **OUT** directions are enabled

The `__ANON__` group is the default routing group. Users in the same group with both directions enabled can see each other's positions and exchange messages.

### Step 3 — Download data packages

Data packages are pre-configured `.zip` files containing server address, certificates, and connection settings. They're the easiest way to configure a client.

1. In the Web UI, go to **Data Packages**
2. For each user, you'll see packages like:
   - `Alice_CONFIG.zip` — for ATAK / WinTAK
   - `Alice_CONFIG_iTAK.zip` — for iTAK
3. Download the appropriate package for each device

### iTAK (iOS)

1. Transfer the `USERNAME_CONFIG_iTAK.zip` file to your iPhone (AirDrop, email, iCloud, etc.)
2. Open the file and choose **Open in iTAK**
3. iTAK will import the server connection, certificates, and settings automatically
4. The server connection should appear and show as connected

### ATAK (Android)

1. Transfer the `USERNAME_CONFIG.zip` file to your Android device
2. Open ATAK > **Settings** > **Network Preferences** > **TAK Servers** > **Import**
3. Select the `.zip` file — ATAK will configure the connection automatically
4. Alternatively, on the phone's browser, download the truststore from `https://YOUR_SERVER_IP/api/truststore`
5. When Android asks what the certificate is for, select **VPN and apps** (not WiFi)
6. Then manually add the server in ATAK with address `YOUR_SERVER_IP`, port `8089`, protocol **SSL**, and your credentials

### WinTAK (Windows)

1. Download the `USERNAME_CONFIG.zip` from the Web UI
2. Open WinTAK > **Settings** > **Network** > **Manage Server Connections** > **Import**
3. Select the `.zip` file

### Manual connection (any client)

If you prefer to connect manually instead of using data packages:

1. Download the truststore: `https://YOUR_SERVER_IP/api/truststore`
2. Truststore password: `atakatak`
3. Add a server with address `YOUR_SERVER_IP`, port `8089`, protocol **SSL**
4. Enter your OTS username/password
5. Enable certificate enrollment

### Verifying connectivity

After connecting two or more devices:

- Each device should see the other's icon on the map
- Open **Contacts** to see other connected users
- Send a chat message from one device — the other should receive it
- If devices can't see each other, verify both users are in the same group with IN and OUT directions enabled, and that location reporting is turned on in each app

## Certificates and Security

### How it works

On first boot, OTS automatically generates:

- A **Certificate Authority (CA)** at `/home/tak/ots/ca/`
- A **server certificate** at `/home/tak/ots/ca/certs/opentakserver/`
- A **truststore** downloadable at `https://YOUR_SERVER_IP/api/truststore`

When a TAK client connects with valid credentials, OTS automatically issues it a **client certificate** signed by the CA. No manual cert distribution required.

### Certificate locations on the server

| File | Path |
|------|------|
| CA certificate | `/home/tak/ots/ca/ca.pem` |
| CA private key | `/home/tak/ots/ca/ca-do-not-share.key` |
| Server certificate | `/home/tak/ots/ca/certs/opentakserver/opentakserver.pem` |
| Server private key | `/home/tak/ots/ca/certs/opentakserver/opentakserver.nopass.key` |
| Truststore (for clients) | `/home/tak/ots/ca/truststore-root.p12` |
| Client certs (auto-generated) | `/home/tak/ots/ca/certs/<username>/` |

### Truststore password

The default truststore password is `atakatak`. This is the standard TAK ecosystem default.

## Destroying the Server

When you're done, tear everything down to stop billing:

1. Go to **Actions** > **OpenTAKServer** > **Run workflow**
2. Select **destroy**
3. Click **Run workflow**

This deletes the droplet, firewall, and SSH key from DigitalOcean. Your DigitalOcean API token and GitHub secrets remain intact, so you can redeploy anytime.

## Local CLI Deploy (Alternative)

If you prefer running Terraform locally instead of using GitHub Actions:

```bash
# Clone your fork
git clone https://github.com/YOUR_USERNAME/opentakserver-infra.git
cd opentakserver-infra

# Configure your variables
cp terraform.tfvars.example terraform.tfvars
```

Edit `terraform.tfvars` with your values:

```hcl
do_token            = "dop_v1_your_token_here"
ssh_public_key_path = "~/.ssh/id_ed25519.pub"
```

Then deploy:

```bash
terraform init
terraform apply
```

Monitor the install:

```bash
ssh root@$(terraform output -raw droplet_ip) 'tail -f /var/log/ots-install.log'
```

Destroy when done:

```bash
terraform destroy
```

## Ports Reference

| Service | Port | Protocol | Description |
|---------|------|----------|-------------|
| SSH | 22 | TCP | Server management |
| Web UI | 443 | TCP | HTTPS dashboard and API |
| HTTPS TAK | 8443 | TCP | TAK API with client cert auth |
| Certificate Enrollment | 8446 | TCP | Client certificate provisioning |
| SSL CoT | 8089 | TCP | Encrypted Cursor-on-Target streaming |
| Video (RTSP) | 8554 | TCP/UDP | Live video streaming via MediaMTX |
| Mumble Voice | 64738 | TCP/UDP | Push-to-talk voice (if enabled) |

## Cost

| Provider | Plan | RAM | vCPUs | Storage | Price |
|----------|------|-----|-------|---------|-------|
| **DigitalOcean** | `s-1vcpu-2gb` | 2 GB | 1 | 50 GB SSD | **$12/mo** |
| Hetzner | CX22 | 4 GB | 2 | 40 GB | ~$4/mo |
| IONOS | VPS S | 2 GB | 1 | 80 GB | ~$5/mo |

Destroy the server when not in use to avoid charges. Deploy/destroy takes ~1 minute via GitHub Actions (plus ~15 minutes for OTS to install on a fresh deploy).

## Troubleshooting

**Workflow fails on deploy:**
- Verify your `DO_TOKEN` secret is a valid DigitalOcean API token with read+write permissions
- Verify `SSH_PUBLIC_KEY` contains the full public key string (starts with `ssh-ed25519` or `ssh-rsa`)

**Can't SSH into the server:**
- Make sure you're using the private key that matches the public key you added as a secret
- `ssh -i ~/.ssh/id_ed25519 root@YOUR_SERVER_IP`

**Web UI won't load / "site cannot be reached":**
- If you use **CloudFlare WARP** (or any DNS-level VPN), it can block self-signed certificates. Disable WARP or add a split tunnel exception for your server IP
- Try from a different device or network to confirm

**Web UI shows 502 or 500 error:**
- OTS is probably still installing. Check `tail -f /var/log/ots-install.log` and wait for the completion banner
- If the install finished but the error persists: `ssh root@YOUR_SERVER_IP 'systemctl restart opentakserver nginx'`

**iTAK/ATAK won't connect:**
- Make sure you downloaded and imported the data package (or truststore) first
- Confirm the port is `8089` and protocol is `SSL`
- Verify you created a user account in the OTS Web UI and are using those credentials
- Check the server is fully installed (the completion banner appears in the install log)

**Devices connected but can't see each other:**
- Both users must be in the same group (e.g. `__ANON__`) with both **IN** and **OUT** directions enabled
- Verify location reporting / GPS is enabled on both devices
- Toggle the server connection off and back on after changing group memberships
- Check RabbitMQ queues: `ssh root@YOUR_SERVER_IP 'rabbitmqctl list_queues name messages consumers'` — callsign queues should have consumers

**Android truststore says "not installed":**
- When Android asks what the certificate is for, select **VPN and apps** (not WiFi)

**Check service status:**

```bash
ssh root@YOUR_SERVER_IP 'for svc in opentakserver cot_parser eud_handler eud_handler_ssl mediamtx nginx rabbitmq-server; do printf "%-20s %s\n" "$svc" "$(systemctl is-active $svc)"; done'
```

All seven services should show `active`.

**Check RabbitMQ routing:**

```bash
ssh root@YOUR_SERVER_IP 'rabbitmqctl list_bindings source_name routing_key destination_name'
```

You should see `groups` exchange bindings with `__ANON__.OUT` routing to each connected user's callsign queue.

## Architecture

```
                    ┌──────────────────────────────────────────────┐
                    │            DigitalOcean Droplet               │
                    │                                              │
  ATAK/iTAK ──────►│  :443   nginx ──► OTS Web UI (:8081)         │
  (SSL CoT)  ──────│  :8089  eud_handler_ssl ──► RabbitMQ         │
  (Certs)    ──────│  :8446  nginx ──► OTS enrollment              │
  (Video)    ──────│  :8554  MediaMTX                              │
                    │                                              │
                    │  Message routing:                             │
                    │  EUD ─► eud_handler ─► cot_parser exchange   │
                    │  cot_parser ─► groups exchange ─► other EUDs │
                    │                                              │
                    │  OTS auto-generates CA + server certs        │
                    │  Clients auto-enroll via credentials         │
                    └──────────────────────────────────────────────┘
```

## Links

- [OpenTAKServer Documentation](https://docs.opentakserver.io/)
- [OpenTAKServer GitHub](https://github.com/brian7704/OpenTAKServer)
- [ATAK (Android)](https://play.google.com/store/apps/details?id=com.atakmap.app.civ)
- [iTAK (iOS)](https://apps.apple.com/app/itak/id1610625892)
- [DigitalOcean API Tokens](https://cloud.digitalocean.com/account/api/tokens)
