#cloud-config

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git

users:
  - default
  - name: tak
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo

write_files:
  - path: /opt/install-ots.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      exec > /var/log/ots-install.log 2>&1

      echo "=== OpenTAKServer Installation Started ==="
      echo "Timestamp: $(date -u)"

      PUBLIC_IP="${fts_public_ip}"
      if [ -z "$PUBLIC_IP" ]; then
        PUBLIC_IP=$(curl -s http://checkip.amazonaws.com || curl -s http://ifconfig.me)
      fi
      echo "Using public IP: $PUBLIC_IP"

      # OTS installer must NOT run as root
      # Download installer, patch out interactive prompts, then run it
      curl https://i.opentakserver.io/ubuntu_installer -L -o /tmp/ots_installer.sh
      # Auto-answer "no" to ZeroTier prompt
      sed -i 's|read -p.*Install ZeroTier.*|INSTALL_ZEROTIER="n"|g' /tmp/ots_installer.sh
      sed -i 's|< /dev/tty||g' /tmp/ots_installer.sh
      chmod +x /tmp/ots_installer.sh
      su - tak -c 'bash /tmp/ots_installer.sh 2>&1' | tee -a /var/log/ots-install.log

      echo "=== OpenTAKServer Installation Complete ==="
      echo "Timestamp: $(date -u)"
      echo ""
      echo "Web UI: https://$PUBLIC_IP"
      echo "SSL CoT: $PUBLIC_IP:8089"
      echo "Cert Enrollment: https://$PUBLIC_IP:8446"
      echo "Truststore: https://$PUBLIC_IP/api/truststore"

runcmd:
  - bash /opt/install-ots.sh
